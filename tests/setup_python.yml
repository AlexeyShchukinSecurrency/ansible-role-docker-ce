---
- name: Install Python on host
  hosts: test-host
  gather_facts: no
  tasks:
    - name: Wait for connection
      wait_for:
          host: "{{ hostvars[inventory_hostname]['ansible_ssh_host'] }}"
          port: 22
          delay: 5
          state: drained
      delegate_to: 127.0.0.1
      register: _connect_result
      until: _connect_result is succeeded

    - name: Determine distribution
      raw: cat /etc/os-release | grep "^NAME=" | cut -d= -f2 | cut -d" " -f1 | sed 's/"//g'
      register: _distribution
      until: _distribution is succeeded
      retries: 10
      delay: 10     
      changed_when: no

    - name: Print distribution information
      become: yes
      debug:
        var: _distribution
      
    - name: Install Python (Debian or Ubuntu)
      become: yes
      raw: type python || (apt-get update && apt-get -y install python-minimal)
      changed_when: no
      when:
        - _distribution.stdout_lines|join('') == "Debian" or _distribution.stdout_lines|join('') == "Ubuntu"

    - name: Install Python (CentOS or RHEL)
      become: yes
      raw: type python || type python2 || type python3 || (yum -y install python)
      changed_when: no
      when:
        - _distribution.stdout_lines|join('') == "CentOS" or _distribution.stdout_lines|join('') == "Red"

    - name: Install Python (Fedora)
      become: yes
      raw: type python || (dnf -y install python)
      changed_when: no
      when:
        - _distribution.stdout_lines|join('') == "Fedora"
